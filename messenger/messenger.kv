<ReplyMessagePane>:
    id: reply_pane
    padding: "10dp", "5dp", "5dp", "5dp"
    size_hint_y: None
    height: replied_text.texture_size[1] + sp(15)
    MDLabel:
        id: replied_text
        text: "Reply to: " + root.text
        msgid: root.msgid
        valign: "center"
        halign: "left"
        shorten: True
        shorten_from: "right"
    MDIconButton:
        icon: "close"
        on_release: root.parent.remove_widget(root)
        pos_hint: {"center_y": .5}

<RightContentCls>:
    disabled: True
    adaptive_size: True
    pos_hint: {"center_y": .5}

    MDIconButton:
        icon: root.icon
        user_font_size: "16sp"
        md_bg_color_disabled: 0, 0, 0, 0

    MDLabel:
        text: root.text
        font_style: "Caption"
        adaptive_size: True
        pos_hint: {"center_y": .5}

<Item>:
    IconLeftWidget:
        icon: root.left_icon
        pos_hint: {"center_y": .5}

    RightContentCls:
        id: container
        icon: root.right_icon
        text: root.right_text

<MyMDTopAppBar@MDTopAppBar>:
    pos_hint: {"top": 1}
    elevation: 0
    md_bg_color: app.theme_cls.accent_color

<ChatDateHeader>:
    size_hint_y: None
    height: 2*content.texture_size[1]
    MDLabel:
        id: content
        text: root.text
        halign: "center"
        pos_hint: {"center_y": .5}

MessengerRoot:
    MDNavigationLayout:
        MDScreenManager:
            id: screen_manager
            MDScreen:
                id: "messenger_screen"
                name: "messenger_screen"
                on_pre_enter: root.load_chats(self)

                MDBoxLayout:
                    orientation: "vertical"
                    MyMDTopAppBar:
                        id: toolbar_messenger
                        title: "LoRa Messenger"
                        left_action_items: [["menu", lambda x: nav_drawer.set_state("open"), "Navigation"]]
                        right_action_items: [["assets/icons/usual_connections.png", app.do], ["assets/icons/lora_network.png", app.do], ["magnify", lambda x: nav_drawer.set_state("open")]]
                    MDBoxLayout:
                        orientation: 'vertical'
                        ScrollView:
                            MDBoxLayout:
                                id: chats_container
                                orientation: 'vertical'
                                padding: 0, "6dp", 0, "10dp"
                                spacing: "1dp"
                                adaptive_height: True

            MDScreen:
                name: "settings_screen"
                MyMDTopAppBar:
                    id: toolbar_settings
                    title: "Settings"
                    left_action_items: [["arrow-left", lambda x: setattr(screen_manager, "current", "messenger_screen"), "123"]]

                MDLabel:
                    text: "Screen 2"
                    halign: "center"

            MDScreen:
                name: "chat_screen"
                current_chat: root.current_chat
                on_pre_enter: root.load_messages(self)
                on_leave: input_field.text = ""

                MDBoxLayout:
                    orientation: "vertical"
                    MyMDTopAppBar:
                        id: toolbar_chat
                        left_action_items: [["arrow-left", lambda x: setattr(screen_manager, "current", "messenger_screen"), "Return to main screen"]]
                        right_action_items: [["arrow-down", lambda x: setattr(messages_scroll, "scroll_y", "0")], ["dots-vertical", root.chat_actions_menu_callback, "Chat options"]]
                        title: str(root.current_chat)

                    MDBoxLayout:
                        id: chat_area
                        orientation: 'vertical'
                        ScrollView:
                            id: messages_scroll
                            scroll_y: 0
                            MDBoxLayout:
                                id: messages_container
                                orientation: 'vertical'
                                padding: "10dp", "6dp", "10dp", "10dp"
                                spacing: "8dp"
                                adaptive_height: True



                    MDBoxLayout:
                        spacing: "3dp"
                        size_hint_y: .1
                        id: input_panel

                        MDIconButton:
                            icon: "sticker-emoji"
                            pos_hint: {"center_y": .5}
                        MDTextField:
                            id: input_field
                            mode: "round"
                            #do_wrap: False
                            #multiline: True
                            pos_hint: {"center_y": .45}
                            text_color_normal: "black"
                            text_color_focus: "black"
                            on_text: setattr(send_message, "icon", "send") if self.text else setattr(send_message, "icon", "microphone-plus") #root.on_text(self.text)
#                        MDIconButton:
#                            id: attachment
#                            icon: "attachment"
#                            pos_hint: { "center_y": .5 }
#                            on_release: app.add_attachment()
                        MDIconButton:
                            id: send_message
                            icon: "microphone-plus"
                            pos_hint: {"center_y": .5}
                            on_release: root.send()


    MDNavigationDrawer:
        id: nav_drawer
        radius: 0
        MDNavigationDrawerMenu:
            MDNavigationDrawerHeader:
                title: "Lain"
                text: "0xacde73bf"
                source: "assets/icons/me2.png"
                spacing: "8dp"
                padding: "12dp", "24dp", 0, "48dp"
                title_font_size: "45sp"
                text_font_size: "20sp"

            MDNavigationDrawerLabel:
                text: "Options"
            MDNavigationDrawerDivider:
            MDNavigationDrawerItem:
                icon: "assets/icons/settings-icon.png"
                text: "Settings"
                on_press: nav_drawer.set_state("close") or setattr(screen_manager, "current", "settings_screen")
            MDNavigationDrawerDivider: